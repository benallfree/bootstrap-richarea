"use strict";!function(t){function e(n){if(i[n])return i[n].exports;var a=i[n]={exports:{},id:n,loaded:!1};return t[n].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){i(1),function(t){t(function(){jQuery.fn.visible=function(){return this.css("visibility","visible")},jQuery.fn.invisible=function(){return this.css("visibility","hidden")},jQuery.fn.visibilityToggle=function(){return this.css("visibility",function(t,e){return"visible"==e?"hidden":"visible"})},t.fn.richarea=function(e){var n=t(this);n.hide();var a=t('<div class=\'richarea\'><div class="richarea-editor">\n  <ul class="sortable">\n    <li :class="{active: currentIdx==index }" :data-index="index" @click="select" @dblclick="edit" v-for="(item,index) in items">\n      <div class="tools">\n        <span class="move btn btn-success btn-xs glyphicon glyphicon-resize-vertical"></span>\n        <span @click="add(index)" class="add btn btn-default btn-xs glyphicon glyphicon-plus"></span>\n        <span @click="edit" class="settings btn btn-default btn-xs glyphicon glyphicon-cog"></span>\n        <span @click="duplicate" class="duplicate btn btn-default btn-xs glyphicon glyphicon-duplicate"></span>\n        <span @click="remove" class="delete btn btn-danger btn-xs glyphicon glyphicon-remove"></span>\n      </div>\n      <div class="item">\n        <layout :forms="forms" :is="\'c\'+item.layout_id" :item="item"></layout>\n      </div>\n    </li>\n    <li class="disabled add text-center">\n      <button @click.prevent="add(null)" class="btn btn-primary btn-xl">+</button>\n    </li>\n  </ul>\n  <div class="modal fade layout-settings" role="dialog">\n    <div class="modal-dialog" role="document">\n      <div class="modal-content">\n        <div class="modal-header">\n          <button class="close" @click="close">\n            <span class="glyphicon glyphicon-remove"></span>\n          </button>\n          <h4 class="modal-title">Edit Component</h4>\n        </div>\n        <div class="modal-body">\n          <template v-if="currentLayout">\n            <template v-if="Object.keys(currentLayout.fields).length>0">\n              <div v-for="(field,fieldName) in currentLayout.fields">\n                <div class="form-horizontal">\n                  <div class="form-group">\n                    <label class="col-xs-2 control-label">{{fieldName | titlecase}}</label>\n                    <div class="col-xs-10">\n                      <div v-if="field.editor==\'text\'">\n                        <input class="form-control" type="text" v-model="currentItem.data[fieldName]"></input>\n                      </div>\n                      <div v-if="field.editor==\'textarea\'">\n                        <textarea class="form-control" rows="3" v-model="currentItem.data[fieldName]"></textarea>\n                      </div>\n                      <div v-if="field.editor==\'link\'">\n                        <input class="form-control" type="text" v-model="currentItem.data[fieldName].href"></input>\n                        <input class="form-control" type="text" v-model="currentItem.data[fieldName].display"></input>\n                      </div>\n                      <div v-if="field.editor==\'image\'">\n                        <div :data-field="fieldName" class="image-editor">\n                          <input accept="image/gif,image/png,image/jpeg" class="cropit-image-input" type="file"></input>\n                          <img :src="currentItem.data[fieldName].croppedImage" class="reference" style="width:100%; display: none"/>\n                          <div class="cropit-preview"></div>\n                          <input class="cropit-image-zoom-input" type="range"></input>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </template>\n            <template v-else>\n              There are no fields to edit for this layout.\n            </template>\n          </template>\n        </div>\n        <div class="modal-footer">\n          <button class="btn btn-default"  @click="close">Close</button>\n        </div>\n      </div>\n    </div>\n  </div>\n  \n  <div class="modal modal-fullscreen fade layouts-modal" role="dialog">\n    <div class="modal-dialog layout-selector" role="document">\n      <div class="modal-content">\n        <div class="modal-header">\n          <button class="close" data-dismiss="modal">\n            <span class="glyphicon glyphicon-remove"></span>\n          </button>\n          <h4 class="modal-title">Add Component</h4>\n        </div>\n        <div class="modal-body">\n          <div>\n            <div :class="{\'btn-success\': selectedCategory == cat[0], \'btn-primary\': selectedCategory != cat[0] }" @click="selectCat(cat)" class="btn btn-xs" style="margin: 2px;" v-for="cat in layoutCategories">\n              {{cat[1]}}\n            </div>\n          </div>\n          <img class="layout" data-dismiss="modal" :data-layout-id="layout.id" :src="layout.thumb" v-for="(layout,index) in layouts" v-if="inActiveCategories(layout)" v-on:click="insert(layout.id)"/>\n        </div>\n        <div class="modal-footer">\n          <button class="btn btn-default" data-dismiss="modal">Close</button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  \n</div>\n</div>');n.after(a);var o=i(2);e=t.extend(!0,{},{root:a,items:[]},e),o.create(e)}})}(jQuery)},function(t,e){Array.prototype.move=function(t,e){if(t==e)return this;if(e>=this.length)for(var i=e-this.length;i--+1;)this.push(void 0);return this.splice(e,0,this.splice(t,1)[0]),this}},function(t,e){function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var n=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),a=function(){function t(){i(this,t)}return n(t,null,[{key:"create",value:function(t){function e(e){var i=this;if(e instanceof Array)return e.forEach(function(t){i.ensureDefaultValues(t)}),e;$.extend(!0,e,{data:{}});var n=t.layouts[e.layout_id];if(n){var a=n.fields;return Object.keys(a).forEach(function(t){t in e.data||(e.data[t]=a[t].defaultValue)}),e}}function i(){return $(t.root).find(".richarea-editor")}function n(){return i().find(".sortable")}if(t=$.extend(!0,{},{layoutCategories:[],userForms:[],imageUploadUrl:null,layouts:[],items:[]},t),0==Object.keys(t.layouts).length)throw new TypeError("You must define at least one layout.");Object.keys(t.layouts).forEach(function(e){var i=t.layouts[e];Vue.component("c"+i.id,{props:["item","forms"],template:"<div class='layout-container'>"+i.template+"</div>",filters:{embedify:function(t){function e(t){var e=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,i=t.match(e);return i&&11==i[2].length?i[2]:"error"}var i=e(t);return"//www.youtube.com/embed/"+i},linebreak:function(t){return t.replace("\n","<br/>")}}})});var a=e($.extend(!0,[],t.items));new Vue({el:i().get(0),data:{content:null,itemsJson:null,currentIdx:null,$currentLayout:null,items:a,layouts:t.layouts,layoutCategories:t.layoutCategories,selectedCategory:0,forms:t.userForms,isCropperInitialized:!1},computed:{currentItem:function(){return this.items[this.currentIdx]},currentLayout:function(){var t=this.items[this.currentIdx];return t?this.layouts[t.layout_id]:null}},filters:{titlecase:function(t){var e=t.replace(/([A-Z])/g," $1"),i=e.charAt(0).toUpperCase()+e.slice(1);return i},jsonify:function(t){return JSON.stringify(t)}},watch:{currentIdx:function(t){this.isCropperInitialized=!1,this.$nextTick(function(){n().find(".tools").hide(),null!=t&&n().find("li.active .tools").show()})},items:{handler:function(t,e){this.calc()},deep:!0}},methods:{add:function(t){this.currentIdx=t;var e=i().find(".layouts-modal");e.modal("show")},selectCat:function(t){this.selectedCategory=t[0]},inActiveCategories:function(t){if(this.selectedCategory==-1)return!0;for(var e=0;e<t.categories.length;e++){var i=t.categories[e];if(this.selectedCategory==i)return!0}return!1},notifyChange:function(){t.onChange&&t.onChange({html:this.content,data:this.items})},close:function(){i().find(".modal.in").modal("hide"),this.calc()},calc:function(){var t=this;this.$nextTick(function(){i().find(".modal.layout-settings.in").length>0||(t.calcContent(),t.calcJson(),t.notifyChange())})},calcJson:function(){this.itemsJson=JSON.stringify(this.items)},calcContent:function(){var t=[];n().find(".item .layout-container").each(function(e,i){var n=$(i).clone();n.find("[data-render]").each(function(t,e){var i=$(e);i.replaceWith(i.data("render"))}),["data-editor","data-field","data-default-value"].forEach(function(t){n.find("["+t+"]").removeAttr(t)});var a=n.html();t.push(a)});var e=$("<div>").addClass("richarea");e.html(t.join("\n")),this.content=e.get(0).outerHTML},select:function(t){var e=$(t.target).closest("li");this.currentIdx=e.index(),this.$currentLayout=e},insert:function(t){var i=e({layout_id:t}),a=n().find("li.active").index();a>=0?(this.items.splice(a,0,i),this.currentIdx=a):(this.items.push(i),this.currentIdx=this.items.length-1)},edit:function(t){var e=i().find(".layout-settings");e.modal("show")},initCropper:function(e){var n=this,a=i().find(".layout-settings");a.on("show.bs.modal",function(){n.isCropperInitialized||a.find(".image-editor").invisible()}),a.on("shown.bs.modal",function(){n.isCropperInitialized||a.find(".image-editor").each(function(e,i){var o=$(i),r=$(i).find(".reference"),l=Math.floor(r.actual("width")),s=Math.floor(r.actual("height")),c=(o.find(".export"),o.data("field")),d=!1;o.cropit({exportZoom:r.get(0).naturalWidth/l,imageBackground:!1,imageBackgroundBorderWidth:0,initialZoom:"fill",width:l,height:s,maxZoom:5,onFileReadError:function(){console.log("onFileReadError",arguments)},onImageError:function(){console.log("onImageError",arguments)},smallImage:"allow",onImageLoaded:function(){if(n.isCropperInitialized){d=!0;var e=o.find("[type=file]"),i=e.get(0).files[0];fr=new FileReader,fr.onload=function(){t.imageUploadUrl&&$.post(t.imageUploadUrl,{data:fr.result},function(t,e){console.log([t,e]),"success"==e&&"success"==t.status&&(n.items[n.currentIdx].data[c].originalImage=t.url,n.items[n.currentIdx].data[c].croppedImage=t.url)})},fr.readAsDataURL(i),n.$currentLayout.find("[data-field="+c+"]").attr("src",o.cropit("export"))}else o.cropit("zoom",n.currentItem.data[c].zoom),o.cropit("offset",n.currentItem.data[c].offset),n.isCropperInitialized=!0,a.find(".image-editor").visible()},onZoomChange:function(){n.isCropperInitialized&&(d=!0,n.items[n.currentIdx].data[c].zoom=o.cropit("zoom"),n.$currentLayout.find("[data-field="+c+"]").attr("src",o.cropit("export")))},onOffsetChange:function(){if(n.isCropperInitialized){d=!0;var t=o.cropit("offset");n.items[n.currentIdx].data[c].offset={x:Math.floor(t.x),y:Math.floor(t.y)},n.$currentLayout.find("[data-field="+c+"]").attr("src",o.cropit("export"))}}}),o.cropit("imageSrc",n.items[n.currentIdx].data[c].originalImage),a.on("hide.bs.modal",function(){d&&t.imageUploadUrl&&$.post(t.imageUploadUrl,{data:o.cropit("export")},function(t,e){console.log([t,e]),"success"==e&&"success"==t.status&&(n.items[n.currentIdx].data[c].croppedImage=t.url)})})})})},duplicate:function(t){this.items.splice(this.currentIdx,0,$.extend(!0,{},this.items[this.currentIdx]))},remove:function(t){var e=confirm("Are you sure you want to delete this item?");e&&(this.items.splice(this.currentIdx,1),this.currentIdx=null)}},mounted:function(){var t=this;this.calc(),i().show(),n().sortable({placeholder:"alert alert-warning",items:"li:not(.disabled)",handle:".move",helper:"clone",stop:function(e,i){i.placeholder.height(i.item.height()),i.placeholder.width(i.item[0].offsetWidth);var a=$(i.item),o=a.data("index"),r=a.index();t.items.move(o,r),t.currentIdx=r,n().sortable("cancel")},cursor:"move"}),this.initCropper(),$.prototype.fullscreen&&i().find(".layouts-modal").fullscreen()}})}}]),t}();t.exports=a}]);